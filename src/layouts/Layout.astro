---
import { ClientRouter } from 'astro:transitions';
import ShoppingListButton from '../components/ShoppingListButton.tsx';
import NotificationStack from '../components/NotificationStack.tsx';
import PWAInstallBanner from '../components/PWAInstallBanner.tsx';
import { SESSION_COOKIE, getApprovedUser, getUserFromSession } from '../lib/auth';

interface Props {
  title: string;
  description?: string;
  user?: any;
  isAdmin?: boolean;
  resolveAuth?: boolean;
  enableTransitions?: boolean;
}

const {
  title,
  description = "Benicja's Family Gallery & Recipes",
  user: userProp,
  isAdmin: isAdminProp,
  resolveAuth = true,
  enableTransitions = true
} = Astro.props;

const sessionId = Astro.cookies.get(SESSION_COOKIE)?.value;

let user = userProp ?? null;
let isAdmin = typeof isAdminProp === 'boolean' ? isAdminProp : false;

if (resolveAuth && !user && sessionId) {
  user = await getUserFromSession(sessionId);
}

if (resolveAuth && user && typeof isAdminProp !== 'boolean') {
  const approvedUser = await getApprovedUser(user.user_email);
  isAdmin = approvedUser?.role === 'admin';
}

const currentPath = Astro.url.pathname;

if (resolveAuth) {
  Astro.response.headers.set('Cache-Control', 'private, no-store, max-age=0');
  Astro.response.headers.set('Vary', 'Cookie');
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="color-scheme" content="light" />
    <meta name="theme-color" content="#ffffff" />
    <link rel="icon" type="image/png" sizes="16x16" href="/images/site_logo_filled_inverted_512.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/images/site_logo_filled_inverted_512.png" />
    <link rel="icon" type="image/png" sizes="48x48" href="/images/site_logo_filled_inverted_512.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/images/site_logo_filled_inverted_512.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/images/site_logo_filled_inverted_512.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/images/site_logo_filled_inverted_512.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Benicja" />
    <link rel="manifest" href="/manifest.json" />
    <script is:inline>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').catch((err) => {
            console.error('Service Worker registration failed:', err);
          });
        });
      }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <script is:inline src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    {enableTransitions && <ClientRouter />}
    <script is:inline>
      // Enable manual scroll restoration
      if ('scrollRestoration' in window.history) {
        window.history.scrollRestoration = 'manual';
      }

      // Identify which recipe card is visible and save it
      const getVisibleRecipeCard = () => {
        const cards = document.querySelectorAll('[data-recipe-slug]');
        if (cards.length === 0) return null;
        
        const viewportCenter = window.innerHeight / 2;
        let closestCard = null;
        let closestDistance = Infinity;
        
        cards.forEach((card) => {
          const rect = card.getBoundingClientRect();
          const cardCenter = (rect.top + rect.bottom) / 2;
          const distance = Math.abs(cardCenter - viewportCenter);
          
          if (distance < closestDistance) {
            closestDistance = distance;
            closestCard = card.getAttribute('data-recipe-slug');
          }
        });
        
        return closestCard;
      };

      // Save scroll tracking
      let saveScrollTimeout;
      if (window.location.pathname === '/recipes') {
        const saveScrollData = () => {
          clearTimeout(saveScrollTimeout);
          saveScrollTimeout = setTimeout(() => {
            const recipeSlug = getVisibleRecipeCard();
            if (recipeSlug) {
              sessionStorage.setItem('recipesVisibleCard', recipeSlug);
            }
            sessionStorage.setItem('recipesScrollPosition', window.scrollY.toString());
          }, 100); // Debounce
        };
        
        window.addEventListener('scroll', saveScrollData, { passive: true });
        saveScrollData();
      }

      // Wait for all images to load
      const waitForImagesLoaded = () => {
        return new Promise((resolve) => {
          const images = document.querySelectorAll('img');
          if (images.length === 0) {
            resolve(null);
            return;
          }
          
          let loadedCount = 0;
          const totalImages = images.length;
          
          images.forEach((img) => {
            if (img.complete) {
              loadedCount++;
              if (loadedCount === totalImages) resolve(null);
            } else {
              img.onload = () => {
                loadedCount++;
                if (loadedCount === totalImages) resolve(null);
              };
              img.onerror = () => {
                loadedCount++;
                if (loadedCount === totalImages) resolve(null);
              };
            }
          });
          
          // Timeout after 3 seconds
          setTimeout(() => resolve(null), 3000);
        });
      };

      // Scroll to recipe card or fallback to saved Y position
      const restoreScrollPosition = async (recipeSlug, fallbackY) => {
        await waitForImagesLoaded();
        
        // Small delay for layout to settle
        await new Promise(r => setTimeout(r, 100));
        
        // Try to scroll to the recipe card first
        if (recipeSlug) {
          const recipeCard = document.querySelector(`[data-recipe-slug="${recipeSlug}"]`);
          if (recipeCard) {
            // Scroll card to top of viewport with 20px offset
            recipeCard.scrollIntoView(true); // Align to top
            
            // Then adjust by 20px downward for spacing
            const headerHeight = 80; // Approximate header height
            window.scrollBy(0, -headerHeight + 20);
            
            // Wait a frame and verify
            await new Promise(r => requestAnimationFrame(r));
            
            // Get final position and check if card is properly positioned
            const rect = recipeCard.getBoundingClientRect();
            const targetViewportY = 140; // Position card roughly 140px down from top (below header)
            
            if (Math.abs(rect.top - targetViewportY) > 10) {
              // Not quite right, fine-tune
              const adjustment = rect.top - targetViewportY;
              window.scrollBy(0, adjustment);
            }
            
            return;
          }
        }
        
        // Fallback to saved Y position if card not found
        if (fallbackY !== undefined && fallbackY > 0) {
          window.scrollTo({ top: fallbackY, left: 0, behavior: 'instant' });
          
          // Additional verification after a frame
          await new Promise(r => requestAnimationFrame(r));
          
          if (Math.abs(window.scrollY - fallbackY) > 5) {
            window.scrollTo({ top: fallbackY, left: 0, behavior: 'instant' });
          }
        }
      };

      // Listen for navigation from recipe back to recipes
      document.addEventListener('astro:before-preparation', (e) => {
        const fromRecipe = window.location.pathname.startsWith('/recipes/') && window.location.pathname !== '/recipes';
        
        if (fromRecipe) {
          // Disable transitions
          document.documentElement.style.viewTransitionName = 'none !important';
          document.body.style.viewTransitionName = 'none !important';
          
          // Mark that we need to restore scroll
          const visibleCard = sessionStorage.getItem('recipesVisibleCard');
          const scrollPos = sessionStorage.getItem('recipesScrollPosition');
          if (visibleCard) {
            sessionStorage.setItem('recipesRestoreCard', visibleCard);
          }
          if (scrollPos) {
            sessionStorage.setItem('recipesRestoreY', scrollPos);
          }
        }
      });

      // Restore after page swap
      document.addEventListener('astro:after-swap', async () => {
        document.documentElement.style.viewTransitionName = '';
        document.body.style.viewTransitionName = '';
        
        if (window.location.pathname === '/recipes') {
          const cardSlug = sessionStorage.getItem('recipesRestoreCard');
          const scrollY = sessionStorage.getItem('recipesRestoreY');
          
          if (cardSlug || scrollY) {
            const fallbackY = scrollY ? parseInt(scrollY) : undefined;
            await restoreScrollPosition(cardSlug, fallbackY);
            sessionStorage.removeItem('recipesRestoreCard');
            sessionStorage.removeItem('recipesRestoreY');
          }
        }
      });

      // Final restoration on page load
      document.addEventListener('astro:page-load', async () => {
        if (window.location.pathname === '/recipes') {
          const cardSlug = sessionStorage.getItem('recipesRestoreCard');
          const scrollY = sessionStorage.getItem('recipesRestoreY');
          
          if (cardSlug || scrollY) {
            const fallbackY = scrollY ? parseInt(scrollY) : undefined;
            await restoreScrollPosition(cardSlug, fallbackY);
            sessionStorage.removeItem('recipesRestoreCard');
            sessionStorage.removeItem('recipesRestoreY');
          }
        }
      });

      // Fallback on window load
      window.addEventListener('load', async () => {
        if (window.location.pathname === '/recipes') {
          const cardSlug = sessionStorage.getItem('recipesRestoreCard');
          const scrollY = sessionStorage.getItem('recipesRestoreY');
          
          if (cardSlug || scrollY) {
            const fallbackY = scrollY ? parseInt(scrollY) : undefined;
            await restoreScrollPosition(cardSlug, fallbackY);
            sessionStorage.removeItem('recipesRestoreCard');
            sessionStorage.removeItem('recipesRestoreY');
          }
        }
      });
    </script>
    <title>{title}</title>
    <style is:global>
      html {
        scrollbar-gutter: stable;
        background-color: #ffffff;
      }

      * {
        -webkit-tap-highlight-color: transparent !important;
        -webkit-touch-callout: none;
      }
      
      body {
        background-color: #ffffff;
        -webkit-font-smoothing: initial;
        -moz-osx-font-smoothing: initial;
      }
      
      button:focus, button:active {
        outline: none !important;
        box-shadow: none !important;
      }

      /* Optional: focus ring fix */
      :focus-visible {
        outline: none !important;
      }

      /* Completely disable view transitions - instant page changes */
      ::view-transition-old(root),
      ::view-transition-new(root) {
        animation: none !important;
        opacity: 1 !important;
        transition: none !important;
      }
      
      ::view-transition {
        animation: none !important;
      }
      
      /* Prevent transition animations from happening at all */
      html[style*="viewTransitionName: none"] {
        view-transition-name: none !important;
      }

      /* Custom minimalist scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
      }

      ::-webkit-scrollbar-thumb {
        background: #e5e7eb;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #d1d5db;
      }

      .logo-mark {
        filter: brightness(0);
      }

      .shopping-list-widget {
        display: none !important;
      }

      .is-recipe-page .shopping-list-widget {
        display: block !important;
      }
    </style>

    <script is:inline>
      document.addEventListener('astro:before-preparation', () => {
        const progress = document.getElementById('nav-progress');
        if (progress) {
          progress.style.transitionDuration = '0ms';
          progress.style.width = '0%';
          progress.style.opacity = '1';
          
          // Force reflow
          progress.offsetHeight;
          
          // Slide to 90% almost all the way over 10 seconds (slow drift)
          progress.style.transitionDuration = '10s';
          progress.style.transitionTimingFunction = 'cubic-bezier(0, 0.5, 0.5, 1)';
          progress.style.width = '90%';
        }
      });

      document.addEventListener('astro:after-preparation', () => {
        const progress = document.getElementById('nav-progress');
        if (progress) {
          // Snap the last bit quickly
          progress.style.transitionDuration = '300ms';
          progress.style.width = '100%';
        }
      });

      document.addEventListener('astro:page-load', () => {
        const progress = document.getElementById('nav-progress');
        if (progress) {
          progress.style.transitionDuration = '300ms';
          progress.style.opacity = '0';
          setTimeout(() => {
            progress.style.width = '0';
          }, 300);
        }
      });
    </script>
  </head>
  <body class={`${(currentPath.startsWith('/recipes')) || (currentPath.startsWith('/gallery')) ? 'bg-gray-100' : 'bg-white'} min-h-screen font-sans text-gray-900 ${currentPath.startsWith('/recipes') ? 'is-recipe-page' : ''}`}>
    <!-- Progress Bar -->
    <div id="nav-progress" class="fixed top-0 left-0 w-0 h-[2px] bg-gray-900 z-[100] transition-all opacity-0 pointer-events-none"></div>

    {currentPath === '/' && <PWAInstallBanner client:load />}

    <header class="bg-white border-b border-gray-100">
      <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16 md:h-20">
          <div class="flex items-center">
            <a href="/" class="flex items-center hover:opacity-70 transition-opacity" aria-label="Benicja's Kitchen">
                <img src="/images/site_logo_512.png" alt="Benicja's Kitchen" class="h-16 md:h-18 w-auto logo-mark" loading="eager" />
                <span class="flex flex-col ml-3 md:ml-3 justify-center py-0 w-max">
                    <span class="text-lg md:text-lg font-serif font-bold text-gray-700 tracking-tighter leading-none">Benicja's</span>
                    <span class="text-lg md:text-lg font-serif font-bold text-gray-700 tracking-tighter leading-none mt-0.5 md:-mt-1.5">Kitchen</span>
                </span>
            </a>
          </div>
          <div class="hidden md:flex items-center space-x-12">
            <a href="/recipes" class={`text-[11px] font-bold uppercase tracking-[0.3em] transition-colors ${currentPath.startsWith('/recipes') ? 'text-gray-900' : 'text-gray-400 hover:text-gray-900'}`}>
              Recipes
            </a>
            <a href="/gallery" class={`text-[11px] font-bold uppercase tracking-[0.3em] transition-colors ${currentPath.startsWith('/gallery') ? 'text-gray-900' : 'text-gray-400 hover:text-gray-900'}`}>
              Gallery
            </a>
            {resolveAuth ? (
              isAdmin && (
                <a href="/portal" class={`text-[11px] font-bold uppercase tracking-[0.3em] transition-colors ${currentPath.startsWith('/portal') ? 'text-gray-900' : 'text-gray-400 hover:text-gray-900'}`}>
                  Admin
                </a>
              )
            ) : (
              <a 
                href="/portal" 
                class={`text-[11px] font-bold uppercase tracking-[0.3em] transition-colors ${currentPath.startsWith('/portal') ? 'text-gray-900' : 'text-gray-400 hover:text-gray-900'} hidden`}
                data-auth-admin
              >
                Admin
              </a>
            )}
            
            <div class="flex items-center gap-x-8">
              <div class="flex items-center gap-x-8" style="align-items: center;">
                {/* Profile button */}
                {resolveAuth ? (
                  user ? (
                    <div class="relative group">
                      <button 
                        class="relative w-8 h-8 rounded-full overflow-hidden border border-gray-100 hover:border-gray-900 transition-colors focus:outline-none"
                        aria-label="User menu"
                      >
                        {user.user_avatar ? (
                          <img src={user.user_avatar} alt="Profile" class="w-full h-full object-cover" referrerpolicy="no-referrer" />
                        ) : (
                          <div class="w-full h-full bg-gray-50 flex items-center justify-center text-gray-300">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                          </div>
                        )}
                      </button>
                      <div class="fixed top-[60px] right-4 w-40 bg-white border border-gray-100 rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 py-2">
                        <div class="px-4 py-2 border-b border-gray-50 mb-1">
                          <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Signed in as</p>
                          <p class="text-xs font-medium text-gray-900 truncate">{user.user_name || user.user_email}</p>
                        </div>
                        <a 
                          href="/auth/logout" 
                          class="block w-full text-left px-4 py-2 text-[10px] font-bold uppercase tracking-[0.2em] text-red-500 hover:bg-red-50 transition-colors"
                        >
                          Logout
                        </a>
                      </div>
                    </div>
                  ) : (
                    <a 
                      href={`/auth/login?next=${currentPath}`}
                      class="relative w-8 h-8 rounded-full overflow-hidden border border-gray-100 ring-1 ring-gray-200 transition-colors flex items-center justify-center -mt-1.5"
                      title="Login with Google"
                    >
                      <div class="w-full h-full flex items-center justify-center bg-gray-50 text-gray-300">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                      </div>
                    </a>
                  )
                ) : null}
              </div>
            </div>
          </div>
          <div class="flex md:hidden items-center gap-2.5">
            <button
              type="button"
              class="inline-flex items-center justify-center w-10 h-10 rounded-full border border-gray-100 text-gray-700 hover:border-gray-400 transition-colors relative z-[95] ml-2"
              aria-label="Open menu"
              aria-expanded="false"
              aria-controls="mobile-nav"
              data-nav-toggle
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-nav-icon="open">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
              <svg class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-nav-icon="close">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
      </nav>
      <div id="mobile-nav" class="fixed inset-0 z-[90] hidden">
        <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" data-nav-close></div>
        <div class="absolute right-0 top-0 w-[82%] max-w-sm bg-white shadow-2xl p-6 flex flex-col h-auto max-h-[calc(100vh-4rem)] overflow-y-auto">
          <div class="flex items-center justify-between mb-8">
            <span class="text-xs font-bold uppercase tracking-[0.3em] text-gray-400">Menu</span>
          </div>

          <div class="space-y-4">
            <a href="/recipes" class={`block text-lg font-semibold ${currentPath.startsWith('/recipes') ? 'text-gray-900' : 'text-gray-500 hover:text-gray-900'}`}>
              Recipes
            </a>
            <a href="/gallery" class={`block text-lg font-semibold ${currentPath.startsWith('/gallery') ? 'text-gray-900' : 'text-gray-500 hover:text-gray-900'}`}>
              Gallery
            </a>
            {resolveAuth ? (
              isAdmin && (
                <a href="/portal" class={`block text-lg font-semibold ${currentPath.startsWith('/portal') ? 'text-gray-900' : 'text-gray-500 hover:text-gray-900'}`}>
                  Admin
                </a>
              )
            ) : (
              <a
                href="/portal"
                class={`block text-lg font-semibold ${currentPath.startsWith('/portal') ? 'text-gray-900' : 'text-gray-500 hover:text-gray-900'} hidden`}
                data-auth-admin
              >
                Admin
              </a>
            )}
          </div>

          <div class="mt-6 pt-4 border-t border-gray-100">
            {resolveAuth ? (
              user ? (
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full overflow-hidden border border-gray-100">
                      {user.user_avatar ? (
                        <img src={user.user_avatar} alt="Profile" class="w-full h-full object-cover" referrerpolicy="no-referrer" />
                      ) : (
                        <div class="w-full h-full bg-gray-50 flex items-center justify-center text-gray-300">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                          </svg>
                        </div>
                      )}
                    </div>
                    <div>
                      <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Signed in</p>
                      <p class="text-sm font-medium text-gray-900 truncate max-w-[170px]">{user.user_name || user.user_email}</p>
                    </div>
                  </div>
                  <a href="/auth/logout" class="text-xs font-bold uppercase tracking-[0.2em] text-red-500">
                    Logout
                  </a>
                </div>
              ) : (
                <a
                  href={`/auth/login?next=${currentPath}`}
                  class="inline-flex items-center justify-center w-full py-3 rounded-full bg-gray-900 text-white text-xs font-bold uppercase tracking-[0.2em]"
                >
                  Sign in
                </a>
              )
            ) : (
              <div class="relative" data-auth-shell>
                <a
                  href={`/auth/login?next=${currentPath}`}
                  class="inline-flex items-center justify-center w-full py-3 rounded-full bg-gray-900 text-white text-xs font-bold uppercase tracking-[0.2em]"
                  data-auth-out
                >
                  Sign in
                </a>
                <div class="hidden" data-auth-in>
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-full overflow-hidden border border-gray-100">
                        <img data-auth-avatar class="w-full h-full object-cover hidden" referrerpolicy="no-referrer" alt="Profile" />
                        <div data-auth-avatar-fallback class="w-full h-full bg-gray-50 flex items-center justify-center text-gray-300">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                          </svg>
                        </div>
                      </div>
                      <div>
                        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Signed in</p>
                        <p data-auth-name class="text-sm font-medium text-gray-900 truncate max-w-[170px]"></p>
                      </div>
                    </div>
                    <a href="/auth/logout" class="text-xs font-bold uppercase tracking-[0.2em] text-red-500">
                      Logout
                    </a>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </header>
    
    <main>
      <slot />
    </main>

    <style is:global>
      .shopping-list-widget-container {
        position: fixed;
        bottom: 1.25rem;
        right: 1.25rem;
        z-index: 100 !important;
        pointer-events: auto !important;
        isolation: isolate !important;
        mix-blend-mode: initial !important;
        transform: translateZ(0) !important;
        will-change: z-index, transform !important;
        view-transition-name: shopping-list-widget;
      }

      /* Force the widget to stay on top of all view transition layers */
      ::view-transition-group(shopping-list-widget),
      ::view-transition-old(shopping-list-widget),
      ::view-transition-new(shopping-list-widget) {
        z-index: 100 !important;
      }
      
      @media (min-width: 768px) {
        .shopping-list-widget-container {
          bottom: 0.75rem;
          right: 0.75rem;
        }
      }
    </style>

    <div 
      class="shopping-list-widget-container shopping-list-widget" 
      transition:persist="shopping-list-widget"
    >
      <ShoppingListButton client:load />
    </div>

    <NotificationStack client:load />

    <script is:inline>
      // Debug: Log when script runs
      console.log('[Netlify Identity] Script starting...');
      console.log('[Netlify Identity] Current URL:', window.location.href);
      console.log('[Netlify Identity] Hash:', window.location.hash);
      
      // Wait for Netlify Identity to be ready
      function initNetlifyIdentity() {
        console.log('[Netlify Identity] Checking if widget is loaded...', !!window.netlifyIdentity);
        
        if (window.netlifyIdentity) {
          console.log('[Netlify Identity] Widget loaded! Initializing...');
          
          window.netlifyIdentity.on("init", function(user) {
            console.log('[Netlify Identity] Init event fired, user:', user);
            if (!user) {
              window.netlifyIdentity.on("login", function() {
                console.log('[Netlify Identity] Login successful, redirecting to /admin/');
                document.location.href = "/admin/";
              });
            }
          });
          
          // Handle invite and recovery tokens
          var hash = window.location.hash;
          if (hash && (hash.indexOf("#invite_token=") !== -1 || hash.indexOf("#recovery_token=") !== -1 || hash.indexOf("#confirmation_token=") !== -1)) {
            console.log('[Netlify Identity] Token detected in URL! Opening modal...');
            window.netlifyIdentity.open();
          } else {
            console.log('[Netlify Identity] No token found in URL');
          }
        } else {
          // Retry if not ready yet
          console.log('[Netlify Identity] Widget not ready yet, retrying in 100ms...');
          setTimeout(initNetlifyIdentity, 100);
        }
      }
      
      // Start when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initNetlifyIdentity);
      } else {
        initNetlifyIdentity();
      }
    </script>

    {!resolveAuth && (
      <script is:inline>
        async function hydrateAuthShell() {
          try {
            const response = await fetch('/api/auth/me', { credentials: 'include' });
            if (!response.ok) return;

            const data = await response.json();
            const shell = document.querySelector('[data-auth-shell]');
            if (!shell) return;

            const loggedOut = shell.querySelector('[data-auth-out]');
            const loggedIn = shell.querySelector('[data-auth-in]');
            const adminLink = document.querySelector('[data-auth-admin]');

            if (!data.authenticated) {
              loggedIn?.classList.add('hidden');
              loggedOut?.classList.remove('hidden');
              adminLink?.classList.add('hidden');
              return;
            }

            loggedOut?.classList.add('hidden');
            loggedIn?.classList.remove('hidden');

            if (data.isAdmin) {
              adminLink?.classList.remove('hidden');
            }

            const nameEl = shell.querySelector('[data-auth-name]');
            if (nameEl) {
              nameEl.textContent = data.user?.name || data.user?.email || '';
            }

            const avatarImg = shell.querySelector('[data-auth-avatar]');
            const avatarFallback = shell.querySelector('[data-auth-avatar-fallback]');
            if (avatarImg && data.user?.avatar) {
              avatarImg.src = data.user.avatar;
              avatarImg.classList.remove('hidden');
              avatarFallback?.classList.add('hidden');
            }
          } catch (error) {
            console.error('Auth hydrate failed', error);
          }
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', hydrateAuthShell);
        } else {
          hydrateAuthShell();
        }

        document.addEventListener('astro:page-load', hydrateAuthShell);
        document.addEventListener('astro:after-swap', hydrateAuthShell);
      </script>
    )}
    <script is:inline>
      (function initMobileNav() {
        if (window.__mobileNavInitialized) return;
        window.__mobileNavInitialized = true;

        const getElements = () => {
          const panel = document.getElementById('mobile-nav');
          const toggle = document.querySelector('[data-nav-toggle]');
          if (!panel || !toggle) return null;

          return {
            panel,
            toggle,
            openIcon: toggle.querySelector('[data-nav-icon="open"]'),
            closeIcon: toggle.querySelector('[data-nav-icon="close"]')
          };
        };

        const openMenu = () => {
          const els = getElements();
          if (!els) return;

          els.panel.classList.remove('hidden');
          document.body.classList.add('overflow-hidden');
          els.toggle.setAttribute('aria-expanded', 'true');
          els.openIcon?.classList.add('hidden');
          els.closeIcon?.classList.remove('hidden');
          els.toggle.setAttribute('aria-label', 'Close menu');
        };

        const closeMenu = () => {
          const els = getElements();
          if (!els) return;

          els.panel.classList.add('hidden');
          document.body.classList.remove('overflow-hidden');
          els.toggle.setAttribute('aria-expanded', 'false');
          els.openIcon?.classList.remove('hidden');
          els.closeIcon?.classList.add('hidden');
          els.toggle.setAttribute('aria-label', 'Open menu');
        };

        document.addEventListener('click', (event) => {
          const target = event.target;
          if (!(target instanceof Element)) return;

          const toggle = target.closest('[data-nav-toggle]');
          if (toggle) {
            const els = getElements();
            if (!els) return;

            if (els.panel.classList.contains('hidden')) {
              openMenu();
            } else {
              closeMenu();
            }
            return;
          }

          if (target.closest('[data-nav-close]')) {
            closeMenu();
          }
        });

        document.addEventListener('astro:before-swap', closeMenu);
        document.addEventListener('astro:page-load', closeMenu);
      })();
    </script>
  </body>
</html>