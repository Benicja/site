---

export const prerender = false;
import { getEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { SESSION_COOKIE, getUserFromSession } from '../../lib/auth';
import { getRecipeHearts } from '../../lib/hearts';
import AddAllToShoppingListButton from '../../components/AddAllToShoppingListButton.astro';

const { slug } = Astro.params;
let recipe = await getEntry('recipes', slug as string);
const isGhost = !recipe;

// Get current user
const sessionId = Astro.cookies.get(SESSION_COOKIE)?.value;
const user = sessionId ? await getUserFromSession(sessionId) : null;

// Get heart data or default to 0 for ghost
const globalHearts = !isGhost ? await getRecipeHearts() : {};
const heartCount = !isGhost ? ((globalHearts as any)[recipe!.slug] || 0) : 0;

const data = isGhost ? {
  title: 'Preparing your recipe...',
  description: 'This recipe was just created and is being processed. It should appear in a few moments!',
  category: 'New Recipe',
  prep_time: 0,
  cook_time: 0,
  servings: 0,
  featured_image: '',
  ingredients: [],
  instructions: []
} : recipe!.data;

const pageTitle = isGhost ? 'New Recipe' : data.title;
const pageDesc = isGhost ? 'Pending deploy' : data.description;
---

<style>
  @keyframes page-fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .recipe-page {
    animation: page-fade-in 0.25s ease-out;
  }
</style>

<Layout title={pageTitle} description={pageDesc} user={user}>
  <div class="recipe-page" data-is-ghost={isGhost ? "true" : "false"}>
    <div class="recipe-shell">
      <section class="recipe-hero">
        <div class="hero-content">
          <h1 class="hero-title hydrate-title">{data.title}</h1>
          <div class="hero-rating">
            <svg class="hero-heart" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 20.364l-7.682-7.682a4.5 4.5 0 016.364-6.364L12 7.636l1.318-1.318a4.5 4.5 0 016.364 6.364L12 20.364z" />
            </svg>
            <span class="hero-rating-count">{heartCount}</span>
            <span class="hero-rating-label">hearts</span>
          </div>
        </div>
      </section>

      <section class="recipe-media">
        <div class="hero-media">
          <img 
            src={data.featured_image || ''} 
            alt={data.title} 
            class={`hero-image hydrate-image ${!data.featured_image ? 'hidden' : ''}`} 
          />
          {!data.featured_image && (
            <div class="hero-fallback"></div>
          )}
        </div>
        <aside class="info-card">
          <h2 class="section-title">Details</h2>
          <div class="meta-card meta-card-category">
            <p class="meta-label">Category</p>
            <p class="meta-value hydrate-category">{data.category}</p>
          </div>
          <div class="hero-meta">
            <div class="meta-card">
              <p class="meta-label">Prep</p>
              <p class="meta-value hydrate-prep">{data.prep_time ? `${data.prep_time} min` : '-'}</p>
            </div>
            <div class="meta-card">
              <p class="meta-label">Cook</p>
              <p class="meta-value hydrate-cook">{data.cook_time ? `${data.cook_time} min` : '-'}</p>
            </div>
            <div class="meta-card">
              <p class="meta-label">Servings</p>
              <p class="meta-value hydrate-servings">{data.servings || '-'}</p>
            </div>
          </div>
        </aside>
      </section>

      <section class="recipe-description">
        <p class="description-text hydrate-description">{data.description}</p>
      </section>

      <section class="recipe-body">
        <aside class="ingredients-card">
          <h2 class="section-title">Ingredients</h2>
          <ul class="ingredients-list hydrate-ingredients">
            {(data.ingredients || []).map((ingredient) => (
              <li class="ingredient-row">
                <span class="ingredient-amount">{ingredient.amount}</span>
                <span class="ingredient-item">{ingredient.item}</span>
              </li>
            ))}
          </ul>
          <div style="margin-top: 1.5rem;">
            {!isGhost && <AddAllToShoppingListButton ingredients={data.ingredients} client:visible />}
          </div>
        </aside>

        <div class="method-card">
          <h2 class="section-title">Method</h2>
          <ol class="method-list hydrate-instructions">
            {(data.instructions || []).map((instruction, index) => (
              <li class="method-step">
                <span class="step-number">{String(index + 1).padStart(2, '0')}</span>
                <p class="step-text">{instruction.step}</p>
              </li>
            ))}
          </ol>
        </div>
      </section>
    </div>
  </div>

  <script is:inline define:vars={{ slug }}>
    // Hydrate from localStorage for optimistic updates
    document.addEventListener('astro:page-load', () => {
      const cacheKey = 'recipe_pending_v1_' + slug;
      const raw = localStorage.getItem(cacheKey);
      
      const ghostEl = document.querySelector('[data-is-ghost="true"]');

      if (!raw) {
        if (ghostEl) {
          // If it's a ghost page and no cache found, redirect to 404
          window.location.href = '/404';
        }
        return;
      }

      try {
        const { timestamp, data } = JSON.parse(raw);
        // If older than 10 minutes, ignore
        if (Date.now() - timestamp > 10 * 60 * 1000) {
          if (ghostEl) window.location.href = '/404';
          return;
        }

        // Compare title to see if the live page has caught up
        const serverTitle = document.querySelector('.hydrate-title')?.textContent;
        if (serverTitle === data.title) {
          // The live page is now up to date or matches the cache
          // Check other fields just to be sure
          const serverDesc = document.querySelector('.hydrate-description')?.textContent;
          if (serverDesc === data.description) {
            console.log('Live page matches cache. Clearing optimistic cache.');
            localStorage.removeItem(cacheKey);
            return;
          }
        }

        console.log('Optimistically hydrating recipe from cache:', slug);

        // Update basic text
        const titleEl = document.querySelector('.hydrate-title');
        if (titleEl) titleEl.textContent = data.title;
        
        const descEl = document.querySelector('.hydrate-description');
        if (descEl) descEl.textContent = data.description;
        
        const categoryEl = document.querySelector('.hydrate-category');
        if (categoryEl) categoryEl.textContent = data.category;
        
        const prepEl = document.querySelector('.hydrate-prep');
        if (prepEl) prepEl.textContent = `${data.prep_time} min`;
        
        const cookEl = document.querySelector('.hydrate-cook');
        if (cookEl) cookEl.textContent = `${data.cook_time} min`;
        
        const servingsEl = document.querySelector('.hydrate-servings');
        if (servingsEl) servingsEl.textContent = data.servings;

        // Update image
        const imgEl = document.querySelector('.hydrate-image');
        const fallbackEl = document.querySelector('.hero-fallback');
        if (imgEl && data.featured_image) {
          imgEl.src = data.featured_image;
          imgEl.alt = data.title;
          
          if ( window.recipeImageCache ) {
            window.recipeImageCache.get(data.featured_image).then((cachedUrl) => {
              if (imgEl && cachedUrl) imgEl.src = cachedUrl;
            });
          }

          imgEl.classList.remove('hidden');
          if (fallbackEl) fallbackEl.classList.add('hidden');
        }

        // Update ingredients
        const ingredientsList = document.querySelector('.hydrate-ingredients');
        if (ingredientsList && data.ingredients) {
          ingredientsList.innerHTML = data.ingredients.map(ing => `
            <li class="ingredient-row">
              <span class="ingredient-amount">${ing.amount}</span>
              <span class="ingredient-item">${ing.item}</span>
            </li>
          `).join('');
        }

        // Update instructions
        const instructionsList = document.querySelector('.hydrate-instructions');
        if (instructionsList && data.instructions) {
          instructionsList.innerHTML = data.instructions.map((ins, i) => `
            <li class="method-step">
              <span class="step-number">${String(i + 1).padStart(2, '0')}</span>
              <p class="step-text">${ins.step}</p>
            </li>
          `).join('');
        }
      } catch (e) {
        console.warn('Failed to hydrate from cache:', e);
      }
    });
  </script>
</Layout>

<style>
  .recipe-page {
    background: #f3f4f6;
    min-height: 100vh;
  }

  .recipe-shell {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px 20px 48px;
    display: flex;
    flex-direction: column;
    gap: 28px;
  }

  .recipe-hero {
    background: transparent;
    border: none;
    padding: 0;
    box-shadow: none;
  }

  .recipe-media {
    display: flex;
    justify-content: center;
  }

  .hero-media {
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    background: #ffffff;
    aspect-ratio: 16 / 9;
    width: 100%;
    height: 100%;
  }

  .hero-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scale(1.01);
  }

  .hero-fallback {
    width: 100%;
    height: 100%;
    background: #ffffff;
  }

  .hero-content {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .hero-tag {
    align-self: flex-start;
    padding: 6px 14px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.06);
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    color: #0f172a;
  }

  .hero-title {
    font-family: "Playfair Display", serif;
    font-size: clamp(2.4rem, 4vw, 3.6rem);
    line-height: 1.05;
    color: #0f172a;
  }

  .hero-rating {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #0f172a;
    font-weight: 600;
  }

  .hero-heart {
    width: 20px;
    height: 20px;
    color: #ef4444;
  }

  .hero-rating-count {
    font-size: 1rem;
  }

  .hero-rating-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: #94a3b8;
  }

  .hero-subtitle {
    color: #475569;
    font-size: 1.05rem;
    line-height: 1.6;
  }

  .hero-meta {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
  }

  .meta-card {
    background: #ffffff;
    border: 1px solid #cbd5e1;
    border-radius: 16px;
    padding: 12px 14px;
  }

  .meta-card-category {
    margin-bottom: 16px;
  }

  .meta-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: #94a3b8;
    margin-bottom: 6px;
  }

  .meta-value {
    font-size: 1.05rem;
    font-weight: 600;
    color: #0f172a;
    white-space: nowrap;
  }

  .recipe-media {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
  }

  .recipe-description {
    background: #ffffff;
    border: 1px solid #cbd5e1;
    border-radius: 24px;
    padding: 24px;
  }

  .description-text {
    font-size: 1.1rem;
    color: #334155;
    line-height: 1.7;
  }

  .recipe-body {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
  }

  .ingredients-card,
  .method-card {
    background: #ffffff;
    border: 1px solid #cbd5e1;
    border-radius: 24px;
    padding: 24px;
  }

  .info-card {
    background: #ffffff;
    border: 1px solid #cbd5e1;
    border-radius: 24px;
    padding: 24px;
    max-width: 260px;
    width: 100%;
  }

  .section-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    color: #94a3b8;
    margin-bottom: 20px;
  }

  .ingredients-list {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .ingredient-row {
    display: grid;
    grid-template-columns: 80px 1fr;
    gap: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid #f1f5f9;
    color: #334155;
  }

  .ingredient-amount {
    font-size: 0.9rem;
    font-style: italic;
    color: #94a3b8;
  }

  .ingredient-item {
    font-size: 1rem;
  }

  .method-list {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .method-step {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 16px;
    align-items: start;
  }

  .step-number {
    font-family: "Playfair Display", serif;
    font-size: 2rem;
    color: #e2e8f0;
    line-height: 1;
  }

  .step-text {
    font-size: 1.05rem;
    color: #1f2937;
    line-height: 1.7;
  }

  @media (min-width: 1024px) {
    .recipe-shell {
      padding: 32px 32px 96px;
    }

    .recipe-media {
      grid-template-columns: minmax(0, 2fr) minmax(200px, 260px);
      align-items: stretch;
    }

    .recipe-body {
      grid-template-columns: minmax(260px, 340px) 1fr;
      align-items: start;
    }
  }

  @media (max-width: 640px) {
    .hero-media {
      aspect-ratio: 4 / 3;
    }

    .info-card {
      max-width: 100%;
    }

    .recipe-body {
      gap: 8px;
    }

    .ingredient-row {
      grid-template-columns: 64px 1fr;
    }

    .step-number {
      font-size: 1.6rem;
    }

    .hero-meta {
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 4px;
    }
  }
</style>