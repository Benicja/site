---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import { SESSION_COOKIE, getApprovedUser, getUserFromSession } from '../lib/auth';
import { getAlbums, getDisplayDate, getDisplayTitle } from '../lib/gallery';
import { supabaseAdmin, type AccessRequest, type ApprovedUser } from '../lib/supabase';
import { getCollection } from 'astro:content';
import { promises as fs } from 'fs';
import path from 'path';

const sessionId = Astro.cookies.get(SESSION_COOKIE)?.value;
const user = sessionId ? await getUserFromSession(sessionId) : null;
const approvedUser = user ? await getApprovedUser(user.user_email) : null;
const isAdmin = approvedUser?.role === 'admin';

// Strict admin check
if (!isAdmin) {
  return Astro.redirect('/gallery');
}

const albums = await getAlbums();
const allRecipes = await getCollection('recipes');

// Load custom recipe order if it exists
let recipeOrder: string[] = [];
try {
  const orderPath = path.join(process.cwd(), '.recipe-order.json');
  const orderData = JSON.parse(await fs.readFile(orderPath, 'utf-8'));
  recipeOrder = orderData.slugs || [];
} catch (error) {
  // File doesn't exist or can't be read, use default sorting
}

// Sort recipes: first by custom order if exists, then by publishDate (newest first), then alphabetically
const recipes = allRecipes.sort((a, b) => {
  const aIndex = recipeOrder.indexOf(a.slug);
  const bIndex = recipeOrder.indexOf(b.slug);
  
  // If both are in custom order, sort by that
  if (aIndex !== -1 && bIndex !== -1) {
    return aIndex - bIndex;
  }
  // If only one is in custom order, it comes first
  if (aIndex !== -1) return -1;
  if (bIndex !== -1) return 1;
  
  // Otherwise, sort by publishDate (newest first), then alphabetically
  const dateDiff = (b.data.publishDate?.getTime() || 0) - (a.data.publishDate?.getTime() || 0);
  if (dateDiff !== 0) return dateDiff;
  return a.data.title.localeCompare(b.data.title);
});

const { data: accessRequests } = await supabaseAdmin
  .from('access_requests')
  .select('*')
  .eq('status', 'pending')
  .order('requested_at', { ascending: false });

const pendingRequests = (accessRequests as AccessRequest[]) || [];
const { data: approvedUsers } = await supabaseAdmin
  .from('approved_users')
  .select('*')
  .order('approved_at', { ascending: false });

const activeUsers = (approvedUsers as ApprovedUser[]) || [];
---

<Layout title="Site Administration" description="Manage gallery and site configuration" user={user} isAdmin={isAdmin}>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="space-y-12">
      <!-- Access Requests -->
      <section class="bg-white border border-gray-100 rounded-3xl p-8 md:p-12 shadow-sm">
        <div class="flex items-center gap-3 mb-8">
          <div class="w-10 h-10 bg-gray-900 rounded-full flex items-center justify-center text-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.121 17.804A4 4 0 0110 16h4a4 4 0 014 4v1H6v-1a4 4 0 01-.879-2.196z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </div>
          <div>
            <h2 class="text-xl font-serif text-gray-900">Access Requests</h2>
            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-1">Pending Approval</p>
          </div>
        </div>

        {pendingRequests.length > 0 ? (
          <div class="space-y-4" id="access-requests">
            {pendingRequests.map((request) => (
              <div
                class="request-row border border-gray-100 rounded-2xl p-6 flex flex-col gap-4"
                data-request-id={request.id}
              >
                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
                  <div>
                    <p class="text-xs font-bold uppercase tracking-widest text-gray-400">Email</p>
                    <p class="text-sm font-semibold text-gray-900 mt-1">{request.email}</p>
                  </div>
                  <div>
                    <p class="text-xs font-bold uppercase tracking-widest text-gray-400">Name</p>
                    <p class="text-sm text-gray-700 mt-1">{request.full_name || 'Not provided'}</p>
                  </div>
                  <div>
                    <p class="text-xs font-bold uppercase tracking-widest text-gray-400">Requested</p>
                    <p class="text-sm text-gray-500 mt-1">{new Date(request.requested_at).toLocaleString()}</p>
                  </div>
                </div>

                <div>
                  <p class="text-xs font-bold uppercase tracking-widest text-gray-400">Message</p>
                  <p class="text-sm text-gray-600 mt-2 whitespace-pre-line">
                    {request.message || 'No message provided.'}
                  </p>
                </div>

                <div class="flex flex-wrap gap-3">
                  <button
                    class="request-approve-btn px-6 py-2 bg-gray-900 text-white text-xs font-bold uppercase tracking-widest rounded-full hover:bg-gray-800 transition-colors"
                    data-request-id={request.id}
                  >
                    Approve
                  </button>
                  <button
                    class="request-reject-btn px-6 py-2 bg-white text-gray-500 text-xs font-bold uppercase tracking-widest rounded-full border border-gray-200 hover:border-gray-400 hover:text-gray-700 transition-colors"
                    data-request-id={request.id}
                  >
                    Reject
                  </button>
                  <span class="request-status text-xs text-gray-400 self-center"></span>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="text-sm text-gray-500">No pending requests.</div>
        )}
      </section>

      <!-- Approved Users -->
      <section class="bg-white border border-gray-100 rounded-3xl p-8 md:p-12 shadow-sm">
        <div class="flex items-center gap-3 mb-8">
          <div class="w-10 h-10 bg-gray-900 rounded-full flex items-center justify-center text-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a4 4 0 00-4-4h-1" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 20H4v-2a4 4 0 014-4h1" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 12a4 4 0 100-8 4 4 0 000 8z" />
            </svg>
          </div>
          <div>
            <h2 class="text-xl font-serif text-gray-900">Approved Users</h2>
            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-1">Active Access</p>
          </div>
        </div>

        {activeUsers.length > 0 ? (
          <div class="space-y-3">
            {activeUsers.map((approved) => (
              <div
                class="approved-row border border-gray-100 rounded-2xl p-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
                data-approved-id={approved.id}
              >
                <div>
                  <p class="text-xs font-bold uppercase tracking-widest text-gray-400">Email</p>
                  <p class="text-sm font-semibold text-gray-900 mt-1">{approved.email}</p>
                  <div class="mt-2 flex items-center gap-2">
                    <span class="text-[9px] font-bold uppercase tracking-widest px-2 py-1 rounded-full bg-gray-100 text-gray-500">
                      {approved.role === 'admin' ? 'Admin' : 'User'}
                    </span>
                    <span class="text-xs text-gray-400">Approved {new Date(approved.approved_at).toLocaleDateString()}</span>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  {approved.role !== 'admin' ? (
                    <button
                      class="make-admin-btn px-5 py-2 bg-gray-900 text-white text-xs font-bold uppercase tracking-widest rounded-full hover:bg-gray-800 transition-colors"
                      data-approved-id={approved.id}
                      data-approved-email={approved.email}
                    >
                      Make Admin
                    </button>
                  ) : (
                    approved.email !== user?.user_email && (
                      <button
                        class="remove-admin-btn px-5 py-2 bg-white text-gray-900 text-xs font-bold uppercase tracking-widest rounded-full border border-gray-200 hover:border-gray-900 transition-colors"
                        data-approved-id={approved.id}
                        data-approved-email={approved.email}
                      >
                        Remove Admin
                      </button>
                    )
                  )}
                  <button
                    class="revoke-user-btn px-5 py-2 bg-white text-red-600 text-xs font-bold uppercase tracking-widest rounded-full border border-red-100 hover:border-red-300 hover:text-red-700 transition-colors"
                    data-approved-id={approved.id}
                    data-approved-email={approved.email}
                  >
                    Revoke
                  </button>
                  <span class="revoke-status text-xs text-gray-400"></span>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="text-sm text-gray-500">No approved users yet.</div>
        )}
      </section>

      <!-- Sync Column -->
      <section class="bg-gray-50 border border-gray-100 rounded-3xl p-8 md:p-12">
        <div class="flex items-center gap-3 mb-8">
          <div class="w-10 h-10 bg-gray-900 rounded-full flex items-center justify-center text-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          <div>
            <h2 class="text-xl font-serif text-gray-900">Add Albums</h2>
            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-1">Google Photos Sync</p>
          </div>
        </div>

        <div class="space-y-4 mb-6">
          <div>
            <label class="text-xs font-bold text-gray-600 uppercase tracking-widest block mb-2">Batch Add Multiple</label>
            <textarea 
              id="batch-urls" 
              placeholder="Paste multiple Google Photos links (one per line)..." 
              rows="6"
              class="w-full px-6 py-4 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-1 focus:ring-gray-200 transition-all font-light text-sm"
            ></textarea>
            <button 
              id="batch-btn"
              class="mt-4 px-10 py-4 bg-gray-900 text-white rounded-xl transition-all font-bold text-sm uppercase tracking-widest hover:bg-gray-800 disabled:opacity-50 flex items-center justify-center gap-2"
            >
              <span id="batch-btn-text">Add</span>
              <div id="batch-spinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            </button>
            <div id="batch-status" class="mt-6 text-xs font-mono uppercase tracking-tight hidden max-h-48 overflow-y-auto p-4 bg-white border border-gray-200 rounded-lg"></div>
          </div>
        </div>
      </section>

      <!-- Albums/Recipes Toggle -->
      <section>
        <div class="flex items-center gap-4 mb-8">
          <button 
            id="toggle-albums-btn"
            class="toggle-content-btn px-6 py-2 bg-gray-900 text-white text-xs font-bold uppercase tracking-widest rounded-full transition-colors"
            data-target="albums"
          >
            Albums ({albums.length})
          </button>
          <button 
            id="toggle-recipes-btn"
            class="toggle-content-btn px-6 py-2 bg-gray-200 text-gray-600 text-xs font-bold uppercase tracking-widest rounded-full hover:bg-gray-300 transition-colors"
            data-target="recipes"
          >
            Recipes ({recipes.length})
          </button>
        </div>

        <!-- Current Albums List -->
        <div id="albums-section" class="content-section">
          <h2 class="text-sm font-bold text-gray-400 uppercase tracking-[0.2em] mb-8">Current Albums</h2>
          <p class="text-xs text-gray-500 mb-4">Drag to reorder</p>
          <div id="albums-list" class="space-y-4">
            {albums.map(album => (
              <div 
                draggable="true"
                class="album-item flex items-center justify-between p-4 border border-gray-100 rounded-2xl hover:bg-gray-50 transition-colors cursor-move hover:shadow-md"
                data-album-id={album.google_album_id}
              >
                <div class="flex items-center gap-4 flex-1">
                  <div class="w-2 h-2 bg-gray-300 rounded-full flex-shrink-0"></div>
                  <div class="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden">
                    <img src={`/api/gallery/image?url=${encodeURIComponent(album.cover_image_url)}&w=200`} alt="" class="w-full h-full object-cover" />
                  </div>
                  <div>
                    <h3 class="text-sm font-bold text-gray-900">{getDisplayTitle(album.title)}</h3>
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest">{getDisplayDate(album.title, album.created_at)} ‚Ä¢ {album.photo_count} Photos</p>
                  </div>
                </div>
                <div class="flex gap-2">
                  <span class="text-[9px] font-bold px-2 py-1 bg-gray-100 text-gray-500 rounded uppercase tracking-tighter">Synced</span>
                  <button 
                    class="delete-album-btn text-[9px] font-bold px-2 py-1 bg-red-100 text-red-600 rounded uppercase tracking-tighter hover:bg-red-200 transition-colors"
                    data-album-id={album.google_album_id}
                    title="Delete this album"
                  >
                    Remove
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>

        <!-- Current Recipes List -->
        <div id="recipes-section" class="content-section hidden">
          <div class="flex items-center justify-between mb-8">
            <div>
              <h2 class="text-sm font-bold text-gray-400 uppercase tracking-[0.2em] mb-2">Current Recipes</h2>
              <p class="text-xs text-gray-500">Drag to reorder</p>
            </div>
            <button 
              id="create-recipe-btn"
              class="text-xs font-bold px-4 py-2 bg-green-100 text-green-600 rounded-full hover:bg-green-200 transition-colors uppercase tracking-tighter"
            >
              + Create New
            </button>
          </div>
          <div id="recipes-list" class="space-y-4">
            {recipes.map(recipe => (
              <div 
                draggable="true"
                class="recipe-item flex items-center justify-between p-4 border border-gray-100 rounded-2xl hover:bg-gray-50 transition-colors cursor-move hover:shadow-md"
                data-recipe-slug={recipe.slug}
              >
                <div class="flex items-center gap-4 flex-1">
                  <div class="w-2 h-2 bg-gray-300 rounded-full flex-shrink-0"></div>
                  <div class="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden flex items-center justify-center">
                    {recipe.data.featured_image ? (
                      <img src={recipe.data.featured_image} alt="" class="w-full h-full object-cover" />
                    ) : (
                      <span class="text-2xl">üç≥</span>
                    )}
                  </div>
                  <div>
                    <h3 class="text-sm font-bold text-gray-900">{recipe.data.title}</h3>
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest">{recipe.data.category} ‚Ä¢ {recipe.data.prep_time + recipe.data.cook_time} mins</p>
                  </div>
                </div>
                <div class="flex gap-2">
                  <button 
                    class="edit-recipe-btn text-[9px] font-bold px-2 py-1 bg-blue-100 text-blue-600 rounded uppercase tracking-tighter hover:bg-blue-200 transition-colors"
                    data-recipe-slug={recipe.slug}
                    title="Edit this recipe"
                  >
                    Edit
                  </button>
                  <button 
                    class="delete-recipe-btn text-[9px] font-bold px-2 py-1 bg-red-100 text-red-600 rounded uppercase tracking-tighter hover:bg-red-200 transition-colors"
                    data-recipe-slug={recipe.slug}
                    title="Delete this recipe"
                  >
                    Remove
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>

        <!-- Recipe Edit Modal -->
        <div id="recipe-edit-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
              <h3 class="text-lg font-bold text-gray-900">Edit Recipe</h3>
              <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            
            <form id="recipe-edit-form" class="p-6 space-y-4">
              <input type="hidden" id="edit-recipe-slug" />
              
              <div>
                <label class="block text-xs font-bold uppercase tracking-widest text-gray-700 mb-2">Title</label>
                <input type="text" id="edit-recipe-title" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required />
              </div>

              <div>
                <label class="block text-xs font-bold uppercase tracking-widest text-gray-700 mb-2">Description</label>
                <textarea id="edit-recipe-description" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" required></textarea>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-bold uppercase tracking-widest text-gray-700 mb-2">Category</label>
                  <select id="edit-recipe-category" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="Breakfast">Breakfast</option>
                    <option value="Dinner">Dinner</option>
                    <option value="Dessert">Dessert</option>
                  </select>
                </div>
              </div>

              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-xs font-bold uppercase tracking-widest text-gray-700 mb-2">Prep Time (mins)</label>
                  <input type="number" id="edit-recipe-prep-time" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" required />
                </div>
                <div>
                  <label class="block text-xs font-bold uppercase tracking-widest text-gray-700 mb-2">Cook Time (mins)</label>
                  <input type="number" id="edit-recipe-cook-time" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" required />
                </div>
                <div>
                  <label class="block text-xs font-bold uppercase tracking-widest text-gray-700 mb-2">Servings</label>
                  <input type="number" id="edit-recipe-servings" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" min="1" />
                </div>
              </div>

              <!-- Featured Image Section -->
              <div class="border-t border-gray-200 pt-4 mt-6">
                <label class="block text-xs font-bold uppercase tracking-widest text-gray-700 mb-4">Featured Image</label>
                <div class="space-y-4">
                  <!-- Image Preview -->
                  <div id="image-preview-container" class="relative w-full max-w-xs rounded-lg overflow-hidden bg-gray-100 aspect-video flex items-center justify-center border border-gray-200">
                    <img id="image-preview" src="" alt="Preview" class="w-full h-full object-cover hidden" />
                    <span id="image-preview-placeholder" class="text-gray-400 text-sm">No image</span>
                  </div>
                  
                  <!-- Upload Input -->
                  <div class="flex gap-2">
                    <input type="file" id="recipe-image-upload" accept="image/*" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" />
                    <button type="button" id="clear-image-btn" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors text-xs font-bold uppercase tracking-tighter">
                      Clear
                    </button>
                  </div>
                  
                  <!-- Or URL option -->
                  <div>
                    <p class="text-xs text-gray-500 mb-2">Or paste image URL:</p>
                    <input type="text" id="edit-recipe-featured-image-url" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="https://..." />
                  </div>
                </div>
              </div>

              <!-- Ingredients Section -->
              <div class="border-t border-gray-200 pt-4 mt-6">
                <label class="block text-xs font-bold uppercase tracking-widest text-gray-700 mb-4">Ingredients</label>
                <div id="ingredients-list" class="space-y-2">
                  <!-- Ingredients will be added here dynamically -->
                </div>
                <button type="button" id="add-ingredient-btn" class="mt-4 text-xs font-bold px-3 py-1 bg-green-100 text-green-600 rounded hover:bg-green-200 transition-colors uppercase tracking-tighter">
                  + Add
                </button>
              </div>

              <!-- Instructions Section -->
              <div class="border-t border-gray-200 pt-4 mt-6">
                <label class="block text-xs font-bold uppercase tracking-widest text-gray-700 mb-4">Instructions</label>
                <div id="instructions-list" class="space-y-2">
                  <!-- Instructions will be added here dynamically -->
                </div>
                <button type="button" id="add-instruction-btn" class="mt-4 text-xs font-bold px-3 py-1 bg-green-100 text-green-600 rounded hover:bg-green-200 transition-colors uppercase tracking-tighter">
                  + Add
                </button>
              </div>

              <div class="flex gap-3 pt-4 border-t border-gray-200 mt-6">
                <button type="submit" id="save-changes-btn" class="flex-1 px-6 py-2 bg-blue-600 text-white font-bold uppercase tracking-widest rounded-lg hover:bg-blue-700 transition-colors">
                  Save Changes
                </button>
                <button type="button" id="cancel-edit-btn" class="flex-1 px-6 py-2 bg-gray-200 text-gray-700 font-bold uppercase tracking-widest rounded-lg hover:bg-gray-300 transition-colors">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script is:inline>
    let draggedElement = null;

    function initializePortal() {
      // Initialize toggle buttons
      const toggleButtons = document.querySelectorAll('.toggle-content-btn');
      
      const switchTab = (target) => {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
          section.classList.add('hidden');
        });
        
        // Show selected section
        const targetSection = document.getElementById(`${target}-section`);
        if (targetSection) {
          targetSection.classList.remove('hidden');
        }
        
        // Update button styles
        toggleButtons.forEach(button => {
          if (button.dataset.target === target) {
            button.classList.remove('bg-gray-200', 'text-gray-600', 'hover:bg-gray-300');
            button.classList.add('bg-gray-900', 'text-white');
          } else {
            button.classList.add('bg-gray-200', 'text-gray-600', 'hover:bg-gray-300');
            button.classList.remove('bg-gray-900', 'text-white');
          }
        });

        // Save preference to localStorage
        localStorage.setItem('adminTabPreference', target);
      };

      // Restore saved tab preference
      const savedTab = localStorage.getItem('adminTabPreference') || 'recipes';
      switchTab(savedTab);

      toggleButtons.forEach(btn => {
        if (btn._hasHandler) return;

        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const target = btn.dataset.target;
          if (target) {
            switchTab(target);
          }
        });

        btn._hasHandler = true;
      });

      // Recipe edit modal handlers
      const editModal = document.getElementById('recipe-edit-modal');
      const closeModalBtn = document.getElementById('close-edit-modal');
      const cancelEditBtn = document.getElementById('cancel-edit-btn');
      const editForm = document.getElementById('recipe-edit-form');

      const closeEditModal = () => {
        if (editModal) editModal.classList.add('hidden');
        if (editForm) {
          editForm.reset();
          editForm._uploadedImageFile = null;
          editForm._isCreateMode = false;
          document.getElementById('edit-recipe-slug').value = '';
        }
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewPlaceholder = document.getElementById('image-preview-placeholder');
        if (imagePreview) imagePreview.classList.add('hidden');
        if (imagePreviewPlaceholder) imagePreviewPlaceholder.classList.remove('hidden');
      };

      // Create recipe button handler
      const createRecipeBtn = document.getElementById('create-recipe-btn');
      if (createRecipeBtn && !createRecipeBtn._hasHandler) {
        createRecipeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          
          // Reset form for create mode
          if (editForm) {
            editForm.reset();
            editForm._isCreateMode = true;
            editForm._uploadedImageFile = null;
            document.getElementById('edit-recipe-slug').value = '';
            
            // Clear ingredients and instructions
            const ingredientsList = document.getElementById('ingredients-list');
            const instructionsList = document.getElementById('instructions-list');
            if (ingredientsList) ingredientsList.innerHTML = '';
            if (instructionsList) instructionsList.innerHTML = '';
            
            // Clear image preview
            const imagePreview = document.getElementById('image-preview');
            const imagePreviewPlaceholder = document.getElementById('image-preview-placeholder');
            const imageUrlInput = document.getElementById('edit-recipe-featured-image-url');
            const fileInput = document.getElementById('recipe-image-upload');
            
            if (imagePreview) imagePreview.classList.add('hidden');
            if (imagePreviewPlaceholder) imagePreviewPlaceholder.classList.remove('hidden');
            if (imageUrlInput) imageUrlInput.value = '';
            if (fileInput) fileInput.value = '';
          }
          
          // Show modal
          if (editModal) editModal.classList.remove('hidden');
        });
        createRecipeBtn._hasHandler = true;
      }

      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeEditModal);
      }

      if (cancelEditBtn) {
        cancelEditBtn.addEventListener('click', (e) => {
          e.preventDefault();
          closeEditModal();
        });
      }

      const editRecipeButtons = document.querySelectorAll('.edit-recipe-btn');
      editRecipeButtons.forEach(btn => {
        if (btn._hasHandler) return;

        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const slug = btn.dataset.recipeSlug;
          if (!slug) return;

          try {
            const response = await fetch(`/api/recipes/get-recipe?slug=${encodeURIComponent(slug)}`);
            const recipe = await response.json();

            if (!response.ok) {
              throw new Error(recipe.error || 'Failed to load recipe');
            }

            // Populate form fields
            document.getElementById('edit-recipe-slug').value = slug;
            document.getElementById('edit-recipe-title').value = recipe.title;
            document.getElementById('edit-recipe-description').value = recipe.description;
            document.getElementById('edit-recipe-category').value = recipe.category;
            document.getElementById('edit-recipe-prep-time').value = recipe.prep_time;
            document.getElementById('edit-recipe-cook-time').value = recipe.cook_time;
            document.getElementById('edit-recipe-servings').value = recipe.servings || '';
            
            // Populate featured image
            const imagePreview = document.getElementById('image-preview');
            const imagePreviewPlaceholder = document.getElementById('image-preview-placeholder');
            const imageUrlInput = document.getElementById('edit-recipe-featured-image-url');
            
            if (recipe.featured_image) {
              imageUrlInput.value = recipe.featured_image;
              imagePreview.src = recipe.featured_image;
              imagePreview.classList.remove('hidden');
              imagePreviewPlaceholder.classList.add('hidden');
            } else {
              imageUrlInput.value = '';
              imagePreview.classList.add('hidden');
              imagePreviewPlaceholder.classList.remove('hidden');
            }
            
            // Reset file input and uploaded flag
            const fileInput = document.getElementById('recipe-image-upload');
            if (fileInput) fileInput.value = '';
            editForm._uploadedImagePath = null;

            // Populate ingredients
            const ingredientsList = document.getElementById('ingredients-list');
            if (ingredientsList) {
              ingredientsList.innerHTML = '';
              const ingredients = recipe.ingredients || [];
              ingredients.forEach((ing, idx) => {
                addIngredientField(ing.item, ing.amount);
              });
            }

            // Populate instructions
            const instructionsList = document.getElementById('instructions-list');
            if (instructionsList) {
              instructionsList.innerHTML = '';
              const instructions = recipe.instructions || [];
              instructions.forEach((ins) => {
                addInstructionField(ins.step);
              });
            }

            // Show modal
            if (editModal) {
              editModal.classList.remove('hidden');
            }
          } catch (err) {
            alert(`Error loading recipe: ${err.message}`);
          }
        });

        btn._hasHandler = true;
      });

      // Helper function to create ingredient field
      const addIngredientField = (item = '', amount = '') => {
        const ingredientsList = document.getElementById('ingredients-list');
        if (!ingredientsList) return;

        const ingredientDiv = document.createElement('div');
        ingredientDiv.className = 'ingredient-item flex gap-2 items-end';
        ingredientDiv.innerHTML = `
          <input type="text" placeholder="Item name" value="${item}" class="flex-1 px-3 py-2 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-400 ingredient-item-input" />
          <input type="text" placeholder="Amount" value="${amount}" class="w-24 px-3 py-2 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-400 ingredient-amount-input" />
          <button type="button" class="remove-ingredient-btn px-2 py-2 text-gray-400 hover:text-red-500 transition-colors flex-shrink-0">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        `;

        ingredientsList.appendChild(ingredientDiv);

        const removeBtn = ingredientDiv.querySelector('.remove-ingredient-btn');
        if (removeBtn) {
          removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            ingredientDiv.remove();
          });
        }
      };

      // Helper function to create instruction field
      const addInstructionField = (step = '') => {
        const instructionsList = document.getElementById('instructions-list');
        if (!instructionsList) return;

        const instructionDiv = document.createElement('div');
        instructionDiv.className = 'instruction-item flex gap-2 items-end';
        instructionDiv.innerHTML = `
          <textarea placeholder="Step description" class="flex-1 px-3 py-2 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-400 instruction-step-input resize-none" rows="2">${step}</textarea>
          <button type="button" class="remove-instruction-btn px-2 py-2 text-gray-400 hover:text-red-500 transition-colors flex-shrink-0">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        `;

        instructionsList.appendChild(instructionDiv);

        const removeBtn = instructionDiv.querySelector('.remove-instruction-btn');
        if (removeBtn) {
          removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            instructionDiv.remove();
          });
        }
      };

      // Add ingredient button
      const addIngredientBtn = document.getElementById('add-ingredient-btn');
      if (addIngredientBtn && !addIngredientBtn._hasHandler) {
        addIngredientBtn.addEventListener('click', (e) => {
          e.preventDefault();
          addIngredientField();
        });
        addIngredientBtn._hasHandler = true;
      }

      // Add instruction button
      const addInstructionBtn = document.getElementById('add-instruction-btn');
      if (addInstructionBtn && !addInstructionBtn._hasHandler) {
        addInstructionBtn.addEventListener('click', (e) => {
          e.preventDefault();
          addInstructionField();
        });
        addInstructionBtn._hasHandler = true;
      }

      if (editForm) {
        if (editForm._formSubmitHandler) return;
        
        editForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const saveBtn = document.getElementById('save-changes-btn');
          if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
          }

          const slug = document.getElementById('edit-recipe-slug').value;
          const isCreate = editForm._isCreateMode || !slug;

          // Collect ingredients
          const ingredients = [];
          const ingredientItems = document.querySelectorAll('.ingredient-item');
          ingredientItems.forEach(item => {
            const ingredientInput = item.querySelector('.ingredient-item-input');
            const amountInput = item.querySelector('.ingredient-amount-input');
            if (ingredientInput && amountInput && (ingredientInput.value || amountInput.value)) {
              ingredients.push({
                item: ingredientInput.value,
                amount: amountInput.value
              });
            }
          });

          // Collect instructions
          const instructions = [];
          const instructionItems = document.querySelectorAll('.instruction-item');
          instructionItems.forEach(item => {
            const stepInput = item.querySelector('.instruction-step-input');
            if (stepInput && stepInput.value.trim()) {
              instructions.push({
                step: stepInput.value.trim()
              });
            }
          });

          // Handle image upload and form submission
          let featuredImageUrl = document.getElementById('edit-recipe-featured-image-url').value;
          let recipeSlug = slug;
          
          try {
            // If creating new recipe, create it first
            if (isCreate) {
              const createData = {
                title: document.getElementById('edit-recipe-title').value,
                description: document.getElementById('edit-recipe-description').value,
                category: document.getElementById('edit-recipe-category').value,
                prep_time: parseInt(document.getElementById('edit-recipe-prep-time').value),
                cook_time: parseInt(document.getElementById('edit-recipe-cook-time').value),
                servings: parseInt(document.getElementById('edit-recipe-servings').value) || 0,
                featured_image: featuredImageUrl,
                ingredients,
                instructions
              };

              const createResponse = await fetch('/api/recipes/create-recipe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(createData)
              });

              const createResult = await createResponse.json();

              if (!createResponse.ok) {
                throw new Error(createResult.error || 'Failed to create recipe');
              }

              recipeSlug = createResult.slug;
            }

            // Handle image upload if file was selected
            if (editForm._uploadedImageFile) {
              try {
                const uploadFormData = new FormData();
                uploadFormData.append('file', editForm._uploadedImageFile);
                uploadFormData.append('slug', recipeSlug);
                
                const uploadResponse = await fetch('/api/recipes/upload-image', {
                  method: 'POST',
                  body: uploadFormData
                });

                const uploadResult = await uploadResponse.json();

                if (!uploadResponse.ok) {
                  throw new Error(uploadResult.error || 'Failed to upload image');
                }

                featuredImageUrl = uploadResult.url;

                // Update recipe with the image URL
                const updateData = {
                  slug: recipeSlug,
                  title: document.getElementById('edit-recipe-title').value,
                  description: document.getElementById('edit-recipe-description').value,
                  category: document.getElementById('edit-recipe-category').value,
                  prep_time: parseInt(document.getElementById('edit-recipe-prep-time').value),
                  cook_time: parseInt(document.getElementById('edit-recipe-cook-time').value),
                  servings: parseInt(document.getElementById('edit-recipe-servings').value) || 0,
                  featured_image: uploadResult.url,
                  ingredients,
                  instructions
                };

                const updateResponse = await fetch('/api/recipes/update-recipe', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(updateData)
                });

                if (!updateResponse.ok) {
                  throw new Error('Failed to update recipe with image');
                }
              } catch (uploadErr) {
                alert(`Image upload failed: ${uploadErr.message}`);
                return;
              }
            } else if (!isCreate) {
              // Update existing recipe without image upload
              const formData = {
                slug: recipeSlug,
                title: document.getElementById('edit-recipe-title').value,
                description: document.getElementById('edit-recipe-description').value,
                category: document.getElementById('edit-recipe-category').value,
                prep_time: parseInt(document.getElementById('edit-recipe-prep-time').value),
                cook_time: parseInt(document.getElementById('edit-recipe-cook-time').value),
                servings: parseInt(document.getElementById('edit-recipe-servings').value) || 0,
                featured_image: featuredImageUrl,
                ingredients,
                instructions
              };

              const response = await fetch('/api/recipes/update-recipe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
              });

              if (!response.ok) {
                throw new Error('Failed to update recipe');
              }
            }

            closeEditModal();
            setTimeout(() => window.location.reload(), 500);
          } catch (err) {
            alert(`Error: ${err.message}`);
          } finally {
            const saveBtn = document.getElementById('save-changes-btn');
            if (saveBtn) {
              saveBtn.disabled = false;
              saveBtn.textContent = 'Save Changes';
            }
          }
        });
        editForm._formSubmitHandler = true;
      }

      // Image upload handlers
      const fileInput = document.getElementById('recipe-image-upload');
      const imagePreview = document.getElementById('image-preview');
      const imagePreviewPlaceholder = document.getElementById('image-preview-placeholder');
      const imageUrlInput = document.getElementById('edit-recipe-featured-image-url');
      const clearImageBtn = document.getElementById('clear-image-btn');

      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const file = (e.target).files?.[0];
          if (!file) return;

          // Validate file type
          if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file');
            fileInput.value = '';
            return;
          }

          // Preview image
          const reader = new FileReader();
          reader.onload = (event) => {
            const dataUrl = event.target?.result;
            if (dataUrl) {
              imagePreview.src = dataUrl;
              imagePreview.classList.remove('hidden');
              imagePreviewPlaceholder.classList.add('hidden');
              imageUrlInput.value = '';
              editForm._uploadedImagePath = null;
              editForm._uploadedImageFile = file;
            }
          };
          reader.readAsDataURL(file);
        });
      }

      if (clearImageBtn) {
        clearImageBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (fileInput) fileInput.value = '';
          imagePreview.classList.add('hidden');
          imagePreviewPlaceholder.classList.remove('hidden');
          imageUrlInput.value = '';
          editForm._uploadedImagePath = null;
          editForm._uploadedImageFile = null;
        });
      }

      if (imageUrlInput) {
        imageUrlInput.addEventListener('change', (e) => {
          const url = (e.target).value;
          if (url) {
            imagePreview.src = url;
            imagePreview.classList.remove('hidden');
            imagePreviewPlaceholder.classList.add('hidden');
            if (fileInput) fileInput.value = '';
            editForm._uploadedImageFile = null;
          } else {
            imagePreview.classList.add('hidden');
            imagePreviewPlaceholder.classList.remove('hidden');
          }
        });
      }

      const makeAdminButtons = document.querySelectorAll('.make-admin-btn');
      makeAdminButtons.forEach((btn) => {
        if (btn._hasHandler) return;

        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const approvedId = btn.dataset.approvedId;
          const approvedEmail = btn.dataset.approvedEmail || 'this user';
          if (!approvedId) return;

          if (!confirm(`Promote ${approvedEmail} to Admin?`)) return;

          const row = btn.closest('.approved-row');
          const status = row?.querySelector('.revoke-status');
          if (status) status.textContent = 'Updating...';

          try {
            const response = await fetch('/api/admin/update-role', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: approvedId, role: 'admin' })
            });

            const result = await response.json();
            if (!response.ok) {
              throw new Error(result.error || 'Failed to update user role');
            }

            if (status) status.textContent = 'User role updated';
            window.location.reload();
          } catch (err) {
            if (status) status.textContent = 'Error updating';
            alert(err.message || 'Failed to update user role');
          }
        });

        btn._hasHandler = true;
      });

      const removeAdminButtons = document.querySelectorAll('.remove-admin-btn');
      removeAdminButtons.forEach((btn) => {
        if (btn._hasHandler) return;

        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const approvedId = btn.dataset.approvedId;
          const approvedEmail = btn.dataset.approvedEmail || 'this user';
          if (!approvedId) return;

          if (!confirm(`Remove admin privileges from ${approvedEmail}?`)) return;

          const row = btn.closest('.approved-row');
          const status = row?.querySelector('.revoke-status');
          if (status) status.textContent = 'Updating...';

          try {
            const response = await fetch('/api/admin/update-role', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: approvedId, role: 'user' })
            });

            const result = await response.json();
            if (!response.ok) {
              throw new Error(result.error || 'Failed to update user role');
            }

            if (status) status.textContent = 'User role updated';
            window.location.reload();
          } catch (err) {
            if (status) status.textContent = 'Error updating';
            alert(err.message || 'Failed to update user role');
          }
        });

        btn._hasHandler = true;
      });

      const revokeButtons = document.querySelectorAll('.revoke-user-btn');
      revokeButtons.forEach((btn) => {
        if (btn._hasHandler) return;

        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const approvedId = btn.dataset.approvedId;
          const approvedEmail = btn.dataset.approvedEmail || 'this user';
          if (!approvedId) return;

          if (!confirm(`Revoke access for ${approvedEmail}?`)) return;

          const row = btn.closest('.approved-row');
          const status = row?.querySelector('.revoke-status');
          if (status) status.textContent = 'Revoking...';

          try {
            const response = await fetch('/api/admin/approved-users', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: approvedId })
            });

            const result = await response.json();
            if (!response.ok) {
              throw new Error(result.error || 'Failed to revoke access');
            }

            if (status) status.textContent = 'Revoked';
            if (row) {
              row.style.opacity = '0.4';
              setTimeout(() => row.remove(), 600);
            }
          } catch (err) {
            if (status) status.textContent = 'Error revoking';
            alert(err.message || 'Failed to revoke access');
          }
        });

        btn._hasHandler = true;
      });

      const requestButtons = document.querySelectorAll('.request-approve-btn, .request-reject-btn');
      requestButtons.forEach((btn) => {
        if (btn._hasHandler) return;

        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const action = btn.classList.contains('request-approve-btn') ? 'approve' : 'deny';
          const requestId = btn.dataset.requestId;
          if (!requestId) return;

          const row = btn.closest('.request-row');
          const status = row?.querySelector('.request-status');
          if (status) status.textContent = 'Updating...';

          try {
            const response = await fetch('/api/admin/requests', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: requestId, action })
            });

            const result = await response.json();
            if (!response.ok) {
              throw new Error(result.error || 'Failed to update request');
            }

            if (status) status.textContent = action === 'approve' ? 'Approved' : 'Rejected';
            if (row) {
              row.style.opacity = '0.4';
              setTimeout(() => row.remove(), 600);
            }
          } catch (err) {
            if (status) status.textContent = 'Error updating request';
            alert(err.message || 'Failed to update request');
          }
        });

        btn._hasHandler = true;
      });

      const batchBtn = document.getElementById('batch-btn');
      const batchUrls = document.getElementById('batch-urls');
      const batchStatus = document.getElementById('batch-status');
      const batchBtnText = document.getElementById('batch-btn-text');
      const batchSpinner = document.getElementById('batch-spinner');

      if (batchBtn && batchUrls && !batchBtn._hasHandler) {
        batchBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          const urls = batchUrls.value
            .split('\n')
            .map(u => u.trim())
            .filter(u => u.length > 0);

          if (urls.length === 0) {
            alert('Please paste at least one URL');
            return;
          }

          batchStatus.classList.remove('hidden', 'text-red-600', 'text-green-600');
          batchStatus.classList.add('text-gray-700');
          batchStatus.innerHTML = `Processing ${urls.length} albums...`;
          batchBtn.disabled = true;
          batchBtnText.textContent = 'Processing...';
          batchSpinner.classList.remove('hidden');

          let successCount = 0;
          let failureCount = 0;
          const results = [];
          const baseDelay = urls.length > 10 ? 2000 : urls.length > 5 ? 1500 : 1000;

          for (let i = 0; i < urls.length; i++) {
            const url = urls[i];
            batchStatus.innerHTML = results.join('<br>') + `<br><span class="text-gray-500">Processing ${i + 1}/${urls.length}... (${baseDelay}ms delay)</span>`;
            batchStatus.scrollTop = batchStatus.scrollHeight;

            try {
              const response = await fetch('/api/gallery/sync-link', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
              });

              const result = await response.json();

              if (response.status === 429) {
                failureCount++;
                results.push(`<span class="text-orange-600">‚ö† Rate limited at position ${i + 1}. Wait 5+ minutes and retry remaining albums.</span>`);
                batchStatus.classList.add('text-orange-600');
                break;
              } else if (result.success) {
                successCount++;
                results.push(`<span class="text-green-600">‚úì ${result.title} (${result.count} photos)</span>`);
              } else {
                failureCount++;
                results.push(`<span class="text-red-600">‚úó Failed: ${result.error}</span>`);
              }
            } catch (err) {
              failureCount++;
              results.push(`<span class="text-red-600">‚úó Error: ${err.message}</span>`);
            }

            if (i < urls.length - 1) {
              await new Promise(resolve => setTimeout(resolve, baseDelay));
            }
          }

          batchStatus.classList.add(failureCount > 0 ? 'text-orange-600' : 'text-green-600');
          batchStatus.innerHTML = results.join('<br>') + `<br><br><strong>Completed: ${successCount}/${urls.length} albums added</strong>`;
          batchBtn.disabled = false;
          batchBtnText.textContent = 'Add';
          batchSpinner.classList.add('hidden');

          setTimeout(() => window.location.reload(), 3000);
        });

        batchBtn._hasHandler = true;
      }

      const deleteButtons = document.querySelectorAll('.delete-album-btn');
      deleteButtons.forEach(btn => {
        if (btn._hasHandler) return;

        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const albumId = btn.dataset.albumId;
          const albumRow = btn.closest('div[class*="flex"][class*="items-center"]');
          const albumTitle = albumRow ? albumRow.querySelector('h3')?.textContent : 'Unknown';

          if (!confirm(`Delete album "${albumTitle}" and all its photos?`)) return;

          btn.disabled = true;
          const originalText = btn.textContent;
          btn.classList.add('opacity-50');
          btn.textContent = 'Deleting...';

          try {
            const response = await fetch('/api/gallery/delete-album', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ albumId })
            });

            const result = await response.json();

            if (result.success) {
              const albumRow = btn.closest('div[class*="flex"][class*="items-center"]');
              if (albumRow) {
                albumRow.style.opacity = '0.3';
                albumRow.style.textDecoration = 'line-through';
              }
              btn.textContent = 'Deleted';
              setTimeout(() => window.location.reload(), 1000);
            } else {
              throw new Error(result.error || 'Failed to delete album');
            }
          } catch (err) {
            alert(`Error: ${err.message}`);
            btn.disabled = false;
            btn.classList.remove('opacity-50');
            btn.textContent = originalText;
          }
        });

        btn._hasHandler = true;
      });

      const deleteRecipeButtons = document.querySelectorAll('.delete-recipe-btn');
      deleteRecipeButtons.forEach(btn => {
        if (btn._hasHandler) return;

        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const slug = btn.dataset.recipeSlug;
          const recipeRow = btn.closest('div[class*="flex"][class*="items-center"]');
          const recipeTitle = recipeRow ? recipeRow.querySelector('h3')?.textContent : 'Unknown';

          if (!confirm(`Delete recipe "${recipeTitle}"?`)) return;

          btn.disabled = true;
          const originalText = btn.textContent;
          btn.classList.add('opacity-50');
          btn.textContent = 'Deleting...';

          try {
            const response = await fetch('/api/recipes/delete-recipe', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ slug })
            });

            const result = await response.json();

            if (result.success) {
              const recipeRow = btn.closest('div[class*="flex"][class*="items-center"]');
              if (recipeRow) {
                recipeRow.style.opacity = '0.3';
                recipeRow.style.textDecoration = 'line-through';
              }
              btn.textContent = 'Deleted';
              setTimeout(() => window.location.reload(), 1000);
            } else {
              throw new Error(result.error || 'Failed to delete recipe');
            }
          } catch (err) {
            alert(`Error: ${err.message}`);
            btn.disabled = false;
            btn.classList.remove('opacity-50');
            btn.textContent = originalText;
          }
        });

        btn._hasHandler = true;
      });

      const albumItems = document.querySelectorAll('.album-item');
      albumItems.forEach(item => {
        if (item._dragInitialized) return;

        item.addEventListener('dragstart', (e) => {
          draggedElement = item;
          item.style.opacity = '0.5';
          e.dataTransfer.effectAllowed = 'move';
        });

        item.addEventListener('dragend', () => {
          draggedElement = null;
          item.style.opacity = '1';
          albumItems.forEach(el => el.classList.remove('border-blue-400', 'border-2'));
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          if (item !== draggedElement) {
            item.classList.add('border-blue-400', 'border-2');
          }
        });

        item.addEventListener('dragleave', () => {
          item.classList.remove('border-blue-400', 'border-2');
        });

        item.addEventListener('drop', async (e) => {
          e.preventDefault();
          if (draggedElement && draggedElement !== item) {
            const albumsList = document.getElementById('albums-list');
            const items = Array.from(albumsList.querySelectorAll('.album-item'));
            const draggedIndex = items.indexOf(draggedElement);
            const targetIndex = items.indexOf(item);

            if (draggedIndex > targetIndex) {
              item.parentNode.insertBefore(draggedElement, item);
            } else {
              item.parentNode.insertBefore(draggedElement, item.nextSibling);
            }

            const newOrder = Array.from(albumsList.querySelectorAll('.album-item'))
              .map(el => el.dataset.albumId);

            try {
              const response = await fetch('/api/gallery/reorder-albums', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ albumIds: newOrder })
              });

              const result = await response.json();
              if (!result.success) {
                throw new Error(result.error || 'Failed to save order');
              }
            } catch (err) {
              alert(`Error saving order: ${err.message}`);
              window.location.reload();
            }
          }
          item.classList.remove('border-blue-400', 'border-2');
        });

        item._dragInitialized = true;
      });

      const recipeItems = document.querySelectorAll('.recipe-item');
      recipeItems.forEach(item => {
        if (item._dragInitialized) return;

        item.addEventListener('dragstart', (e) => {
          draggedElement = item;
          item.style.opacity = '0.5';
          e.dataTransfer.effectAllowed = 'move';
        });

        item.addEventListener('dragend', () => {
          draggedElement = null;
          item.style.opacity = '1';
          recipeItems.forEach(el => el.classList.remove('border-blue-400', 'border-2'));
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          if (item !== draggedElement) {
            item.classList.add('border-blue-400', 'border-2');
          }
        });

        item.addEventListener('dragleave', () => {
          item.classList.remove('border-blue-400', 'border-2');
        });

        item.addEventListener('drop', async (e) => {
          e.preventDefault();
          if (draggedElement && draggedElement !== item) {
            const recipesList = document.getElementById('recipes-list');
            const items = Array.from(recipesList.querySelectorAll('.recipe-item'));
            const draggedIndex = items.indexOf(draggedElement);
            const targetIndex = items.indexOf(item);

            if (draggedIndex > targetIndex) {
              item.parentNode.insertBefore(draggedElement, item);
            } else {
              item.parentNode.insertBefore(draggedElement, item.nextSibling);
            }

            const newOrder = Array.from(recipesList.querySelectorAll('.recipe-item'))
              .map(el => el.dataset.recipeSlug);

            try {
              const response = await fetch('/api/recipes/reorder-recipes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ slugs: newOrder })
              });

              const result = await response.json();
              if (!result.success) {
                throw new Error(result.error || 'Failed to save order');
              }
            } catch (err) {
              alert(`Error saving order: ${err.message}`);
              window.location.reload();
            }
          }
          item.classList.remove('border-blue-400', 'border-2');
        });

        item._dragInitialized = true;
      });
    }

    initializePortal();
    document.addEventListener('astro:page-load', initializePortal);
  </script>
</Layout>
