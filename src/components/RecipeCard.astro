---

import AddToShoppingListIconButton from './AddToShoppingListIconButton.astro';
import type { CollectionEntry } from 'astro:content';

interface Props {
  recipe: CollectionEntry<'recipes'>;
  user?: any;
  isHearted?: boolean;
  heartCount?: number;
}

const { recipe, user, isHearted = false, heartCount = 0 } = Astro.props;
const { data, slug } = recipe;

// Calculate total time
const totalTime = data.prep_time + data.cook_time;
---

<style>
  .heart-button {
    -webkit-tap-highlight-color: transparent !important;
    outline: none !important;
  }
  .heart-button:focus, .heart-button:active {
    outline: none !important;
    box-shadow: none !important;
  }
</style>

<article class="group relative bg-gray-50/80 border border-gray-200 rounded-xl overflow-hidden hover:shadow-2xl transition-all duration-700 ease-out flex flex-col h-full">
  <!-- Recipe Image -->
  <div class="aspect-[16/10] overflow-hidden bg-gray-100 relative">
    {data.featured_image ? (
      <img 
        src={data.featured_image} 
        alt={data.title}
        class="w-full h-full object-cover transition-transform duration-[2s] ease-out group-hover:scale-110"
        loading="lazy"
      />
    ) : (
      <div class="w-full h-full flex items-center justify-center text-gray-300">
        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      </div>
    )}
    
    <!-- Add Button and Category Overlay -->
    <div class="absolute top-4 left-4 z-20 flex items-center gap-2 md:flex">
      <AddToShoppingListIconButton ingredients={data.ingredients} className="w-8 h-8" />
      <a 
        href={`/recipes?category=${data.category}`}
        class="hidden md:inline-block category-tag px-3 py-1 bg-white/90 backdrop-blur-md text-[10px] font-bold uppercase tracking-widest text-gray-900 rounded-full shadow-sm hover:bg-white transition-colors cursor-pointer select-none"
        data-category={data.category}
      >
        {data.category}
      </a>
    </div>
  </div>
  
  <!-- Recipe Content -->
  <div class="pt-3 pb-5 md:p-8 flex flex-col flex-1">
    <div class="flex-1">
      <div class="flex flex-col items-center gap-1 md:gap-2 md:mb-3 justify-center w-full">
        <h3 class="text-lg md:text-2xl font-serif font-medium text-gray-900 group-hover:text-primary-600 transition-colors duration-300 m-0 flex-1 text-center">
          <a href={`/recipes/${slug}`} class="after:absolute after:inset-0 recipe-link">
            {data.title}
          </a>
        </h3>
        <a 
          href={`/recipes?category=${data.category}`}
          class="md:hidden category-tag px-3 py-1 bg-white/90 backdrop-blur-md text-[10px] font-bold uppercase tracking-widest text-gray-900 rounded-full shadow-sm hover:bg-white transition-colors cursor-pointer select-none"
          data-category={data.category}
        >
          {data.category}
        </a>
      </div>
      <p class="hidden md:block text-gray-500 text-sm font-light leading-relaxed md:line-clamp-2 mb-3 text-center w-full">
        {data.description}
      </p>
      <style is:global>
        /* Ensure ellipsis for line clamping on desktop */
        @media (min-width: 768px) {
          .md\:line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
          }
        }
      </style>
    </div>
    
    <!-- Recipe Meta -->
    <div class="pt-3 border-t border-gray-50 flex items-center justify-center -ml-4">
      <div class="flex items-center gap-4 text-[9px] md:text-[11px] font-bold uppercase tracking-widest text-gray-400">
        <div class="flex items-center gap-1">
          <svg class="w-4 h-4 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span class="text-xs md:text-sm font-light lowercase text-gray-600">{totalTime} min</span>
        </div>
        <div class="flex items-center gap-1">
          <svg 
            class="meta-heart-icon w-4 h-4 md:w-6 md:h-6 transition-colors duration-300 text-gray-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
          </svg>
          <span class="text-xs md:text-sm font-light lowercase text-gray-600 heart-count">{heartCount}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Right Heart Icon -->
  <div class="absolute top-3 right-3 z-[30]">
    <button 
      type="button"
      class="heart-button transition-all duration-300 hover:scale-110 active:scale-95 focus:outline-none focus:ring-0 cursor-pointer p-1 select-none bg-transparent border-none appearance-none"
      data-slug={slug}
      data-hearted={isHearted.toString()}
      data-user={user ? 'true' : 'false'}
    >
      <svg 
        class={`top-heart-icon w-8 h-8 drop-shadow-md transition-all duration-300 ${isHearted ? 'fill-red-500 stroke-red-500 text-red-500' : 'fill-none stroke-white text-white'}`} 
        viewBox="0 0 24 24"
        fill={isHearted ? 'currentColor' : 'none'}
        stroke="currentColor"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
      </svg>
    </button>
  </div>
</article>

<script>
  function initHearts() {
    const buttons = document.querySelectorAll('.heart-button');
    
    buttons.forEach(button => {
      if ((button as any)._heartInited) return;
      (button as any)._heartInited = true;

      button.addEventListener('click', async (e) => {
        // Stop propagation to prevent card link from triggering
        e.preventDefault();
        e.stopPropagation();
        const isLoggedIn = button.getAttribute('data-user') === 'true';
        
        // If not logged in, redirect to Google sign-in
        if (!isLoggedIn) {
          const currentUrl = window.location.pathname + window.location.search;
          window.location.href = `/auth/login?next=${encodeURIComponent(currentUrl)}`;
          return;
        }

        e.stopPropagation();

        const slug = button.getAttribute('data-slug');
        if (!slug) return;

        const wasHearted = button.getAttribute('data-hearted') === 'true';
        const nowHearted = !wasHearted;
        
        const card = button.closest('article');
        const countSpan = card?.querySelector('.heart-count');
        const topSvg = button.querySelector('.top-heart-icon');
        const metaSvg = card?.querySelector('.meta-heart-icon');

        // Update Icons & Count
        const updateUI = (isH: boolean) => {
          button.setAttribute('data-hearted', isH.toString());
          // Also update the parent item for filtering
          if (card?.parentElement?.classList.contains('recipe-item')) {
            card.parentElement.setAttribute('data-hearted', isH.toString());
          }
          
          if (isH) {
            // Top Heart
            topSvg?.classList.remove('fill-none', 'stroke-white', 'text-white');
            topSvg?.classList.add('fill-red-500', 'stroke-red-500', 'text-red-500');
            topSvg?.setAttribute('fill', 'currentColor');
            // Meta Heart stays neutral
            metaSvg?.classList.add('text-gray-400');
            metaSvg?.classList.remove('fill-red-500', 'stroke-red-500', 'text-red-500');
            metaSvg?.setAttribute('fill', 'none');
          } else {
            // Top Heart
            topSvg?.classList.add('fill-none', 'stroke-white', 'text-white');
            topSvg?.classList.remove('fill-red-500', 'stroke-red-500', 'text-red-500');
            topSvg?.setAttribute('fill', 'none');
            // Meta Heart stays neutral
            metaSvg?.classList.add('text-gray-400');
            metaSvg?.classList.remove('fill-red-500', 'stroke-red-500', 'text-red-500');
            metaSvg?.setAttribute('fill', 'none');
          }
        };

        const updateCount = (increase: boolean) => {
          if (countSpan) {
            const currentCount = parseInt(countSpan.textContent || '0');
            countSpan.textContent = (increase ? currentCount + 1 : Math.max(0, currentCount - 1)).toString();
          }
        };

        // 1. Optimistic Update
        updateUI(nowHearted);
        updateCount(nowHearted);

        // 2. Background Request
        try {
          const res = await fetch('/api/recipes/heart', {
            method: 'POST',
            body: JSON.stringify({ slug }),
            headers: { 'Content-Type': 'application/json' }
          });

          if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'Failed to heart');
          }
        } catch (err) {
          console.error('Hearting failed, reverting:', err);
          // Revert UI on failure
          updateUI(wasHearted);
          updateCount(wasHearted);
        }
      });
    });
  }

  // Initial init
  initHearts();

  // Re-init for Astro view transitions
  document.addEventListener('astro:after-swap', initHearts);
  document.addEventListener('astro:page-load', initHearts);

  // Ensure recipe links navigate properly with timeout fallback
  function initRecipeLinks() {
    const recipeLinks = document.querySelectorAll('.recipe-link');
    
    recipeLinks.forEach(link => {
      if ((link as any)._navigationHandled) return;
      (link as any)._navigationHandled = true;
      
      link.addEventListener('click', (e) => {
        // Save scroll position before navigating
        if (window.location.pathname === '/recipes') {
          sessionStorage.setItem('recipesScrollY', window.scrollY.toString());
        }
        
        const href = (link as HTMLAnchorElement).href;
        let navigationCompleted = false;
        
        // Mark when page load completes
        const onPageLoad = () => {
          navigationCompleted = true;
          document.removeEventListener('astro:page-load', onPageLoad);
        };
        
        document.addEventListener('astro:page-load', onPageLoad);
        
        // Fallback: if navigation hasn't completed after 3 seconds, force it
        const timeoutId = setTimeout(() => {
          if (!navigationCompleted) {
            console.warn('Recipe navigation timeout, forcing navigation');
            window.location.href = href;
          }
        }, 3000);
        
        // If navigation completes normally, clear the timeout
        document.addEventListener('astro:after-swap', () => {
          clearTimeout(timeoutId);
        }, { once: true });
      });
    });
  }
  
  initRecipeLinks();
  document.addEventListener('astro:after-swap', initRecipeLinks);
  document.addEventListener('astro:page-load', initRecipeLinks);
</script>